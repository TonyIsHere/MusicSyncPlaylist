<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
	rel="stylesheet"
	integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
	crossorigin="anonymous">
<link rel="stylesheet"
	href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css"
	integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p"
	crossorigin="anonymous" />

<script
	src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"
	integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p"
	crossorigin="anonymous"></script>
<script
	src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js"
	integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF"
	crossorigin="anonymous"></script>
<script
	src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<title>New Playlist</title>
</head>
<body>
	<div th:insert="navbar">...</div>
	<div class="container">
		<!-- Disable component to help JS to work -->
		<form id="formSave" th:action="@{/api/save}" method="POST"></form>
		<div id="datajsid" class="d-none" th:text="${session.id}">John
			Doe</div>
		<h1>New Playlist</h1>
		<div class="row">
			<div class="col-12">
				<form action="#" th:action="@{/search}" method="GET"
					class="card card-sm">
					<div class="card-body row no-gutters align-items-center">
						<div class="col-auto">
							<i class="fas fa-search h4 text-body"></i>
						</div>
						<div class="col">
							<input th:name="q" th:value="${param.q}"
								class="form-control form-control-lg form-control-borderless"
								type="search" placeholder="Search Track or Artist">
						</div>
						<div class="col-auto">
							<button class="btn btn-lg btn-success" type="submit">Search</button>
						</div>
					</div>
				</form>
			</div>
		</div>
		<div class="row">
			<div class="col-12">
				<div class="card-body row no-gutters align-items-center">
					<div class="col-auto">
						<i class="h4 text-body">Name</i>
					</div>
					<div class="col">
						<input id="inputName"
							class="form-control form-control-lg form-control-borderless"
							type="search" placeholder="Name playlist">
					</div>
				</div>
			</div>
		</div>
		<div class="row" style="margin-top: 10px">
			<div class="col-md-6 col-sm-12">
				<h2>Search</h2>
				<ul class="list-unstyled"
					style="max-height: 70vh; overflow-y: auto;">
					<li th:each="item : ${search}" th:id="'item-search-'+${item.id}"
						class="border rounded item-to-add"
						style="padding: 10px; margin-top: 10px"><a target="_blank"
						th:href="'https://open.spotify.com/track/' + ${item.spotify}">Spotify
							link</a>
						<div class="d-flex align-items-center">
							<div class="flex-shrink-0">
								<img th:src="${item.album.picture}" alt="playlist"
									class="img-thumbnail" style="width: 100px">
							</div>
							<div class="flex-grow-1 ms-3">
								<h5 class="mt-0 mb-1" th:text="${item.name}"></h5>
								<p th:text="${item.getArtistsString}"></p>
								<span th:if="${item.preview == Null}"></span> <span
									th:unless="${item.preview == Null }">
									<Button th:attr="onclick=|playAudio('${item.id}')|">Play
										preview</Button> <audio th:id="'btn_'+${item.id}" controls
										class="d-none" style="height: revert; width: 100%">
										<source th:src="${item.preview}" type="audio/mpeg">
										Your browser does not support the audio element.
									</audio>
								</span>
							</div>
							<button type="button"
								class="btn btn-success btn-lg float-right btn-add"
								th:attr="data-id=|${item.id}|">
								<i class="fa fa-plus"></i>
							</button>
						</div></li>
				</ul>
			</div>
			<div class="col-md-6 col-sm-12">
				<h2>Playlist</h2>
				<ul id="playlistContainer" class="list-unstyled"
					style="max-height: 70vh; overflow-y: auto;">
				</ul>
			</div>
		</div>
		<div class="row" style="margin-top: 10px; margin-bottom: 10px">
			<div class="col-12">
				<button id="btn-save" type="button"
					class="btn btn-primary float-right btn-lg" style="width: 100%">Create
					a new playlist</button>
			</div>
		</div>
	</div>
</body>
<script type="text/javascript">
let storage = [];

//get id from backend
let idUser = parseInt($(datajsid).html());
$(datajsid).remove()


/**
* Save playlist el to localstorage
*/
function saveLocal() {
  localStorage.setItem("playlist", JSON.stringify(storage));
}

/**
* Process to load from localstorage
*/
if (localStorage.getItem("name")) {
  inputName.value = localStorage.getItem("name");
}

if (localStorage.getItem("playlist")) {
  storage = JSON.parse(localStorage.getItem("playlist"));
  for (let i = 0; i < storage.length; i++) {
      //Create tmp DOM to convert String to DOM 
      let tmp = document.createElement("div");
      tmp.innerHTML = storage[i];
      let el = tmp.firstChild;

      //Use Jquery to find the button and add event click
      $(el).find(".btn-del")[0].addEventListener("click", e => deleteRow(e))

      //Finally add on the view
      $("#playlistContainer").append(el);
  }
}



/**
* Event click to each result row to add to new playlist
*/
$(".item-to-add .btn-add").each((i, x) => {
  let id = x.dataset.id;
  x.addEventListener("click", _ => {
      let el = $("#item-search-" + id).clone();		//Duplicate the el (otherwise it will be removed of search list)

      //Change data
      el.attr("id", "item-playlist-" + id);

      //Add a btn to remove from the playlist with event 
      let btnRemove = $($.parseHTML(`<button type="button" class="btn btn-danger float-right btn-lg btn-del" data-id="${id}"><i class="fa fa-times"></i></button>`));
      btnRemove[0].addEventListener("click", e => deleteRow(e))

      el.find(".btn-add").replaceWith(btnRemove);

      //Create a temp DOM to convert DOM to String
      let tmp = document.createElement("div");
      $(tmp).append(el);

      storage.push($(tmp).html());

      //Add on the view
      $("#playlistContainer").append(el);

      saveLocal();
  });
});

/**
* On click to a play preview btn
* @param {int} btnid 
*/
function playAudio(btnid) {
  el = document.getElementById("btn_" + btnid); //el clicked

  $('audio').each((i, x) => {
      x.pause() //pause  sound of each
      if (x !== el) { //set time of 0 to el clicked
          x.currentTime = 0;
      }
  });
  if (el.currentTime != 0) //On listen
  {
      el.pause()
      el.currentTime = 0;
  }
  else { //restart
      el.currentTime = 0; 
      el.play();
  }
}

/**
* Save playlist and redirect to playlist page
*/
function save() {
  let playlistItem = []
  $("#playlistContainer").children().each((i, x) => {
      let id = x.id.split("-")[2];
      playlistItem.push(id);
  })

  let name = inputName.value;

  var f = formSave;
  f.setAttribute('method', "post");
  f.setAttribute('action', "api/save");

  var i = document.createElement("input"); //input element, text
  i.setAttribute('type', "text");
  i.setAttribute('name', "id");
  i.setAttribute('value', idUser);
  f.appendChild(i);

  var i = document.createElement("input"); //input element, text
  i.setAttribute('type', "text");
  i.setAttribute('name', "allTrackId");
  i.setAttribute('value', playlistItem);
  f.appendChild(i);

  var i = document.createElement("input"); //input element, text
  i.setAttribute('type', "text");
  i.setAttribute('name', "name");
  i.setAttribute('value', name);
  f.appendChild(i);

  var s = document.createElement("input"); //input element, Submit button
  s.setAttribute('type', "submit");
  s.setAttribute('value', "Submit");
  f.appendChild(s);

  document.body.appendChild(f);

  clearLocalStorage();

  f.submit();
}

/**
* Delete row from playlist item
*/
function deleteRow(btnRemove) {
  btnRemove = $(btnRemove.currentTarget);
  let elToRemove = btnRemove.parent().parent();
  storage.splice(elToRemove.index(), 1)
  elToRemove.remove();
  saveLocal();
}

/**
* On keypress save to localstorage
*/
inputName.addEventListener("keyup", e => {
  localStorage.setItem("name", e.target.value);
});

/**
* Clear local storage
*/
function clearLocalStorage() {
  window.localStorage.removeItem('name');
  window.localStorage.removeItem('playlist');
}

document.getElementById("btn-save").addEventListener("click", save);
</script>
</html>
